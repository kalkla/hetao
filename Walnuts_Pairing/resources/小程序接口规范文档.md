# 核桃检测小程序API接口规范

## 1. 基础信息

### 认证方式
- 使用 JWT Token (Bearer Token) 进行身份验证
- Token 存储：使用微信本地缓存 `wx.setStorageSync('token')`
- 用户信息存储：使用微信本地缓存 `wx.setStorageSync('userInfo')`
- 全局登录状态：通过 `app.globalData.isLoggedIn` 管理

### 通用请求头
```
Authorization: Bearer {token}
Content-Type: application/json
```

### 通用错误响应格式
```json
{
  "success": false,
  "message": "错误信息描述"
}
```

## 2. 接口详细规范

### 2.1 微信登录接口

**接口路径**: `/api/login`
**请求方式**: `POST`
**是否需要认证**: 否

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| `code` | `string` | `是` | 微信登录code，通过 `wx.login()` 获取 |

**成功响应格式**:
```json
{
  "success": true,
  "token": "jwt_token_string",
  "isFirstLogin": true, // 是否首次登录，true表示首次登录，false表示非首次登录
  "userInfo": {
    "nickName": "用户昵称",
    "avatarUrl": "头像URL",
    "openId": "用户唯一标识"
  }
}
```

### 2.2 用户信息完善接口

**接口路径**: `/api/user/register`
**请求方式**: `POST`
**是否需要认证**: 是

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| `nickName` | `string` | `是` | 用户昵称 |
| `avatarUrl` | `string` | `否` | 头像URL（临时路径，后端处理上传） |

**成功响应格式**:
```json
{
  "success": true,
  "message": "用户信息完善成功",
  "userInfo": {
    "nickName": "用户昵称",
    "avatarUrl": "头像URL",
    "openId": "用户唯一标识"
  }
}

### 2.3 图片上传接口

**接口路径**: `/upload`
**请求方式**: `POST`
**是否需要认证**: 是

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| `file` | `File` | `是` | 要上传的图片文件 |
| `purpose` | `string` | `否` | 用途标识，可选值: 'collection'(采集)或'comparison'(对比) |

**成功响应格式**:
```json
{
  "success": true,
  "file_id": "upload_xxxxxxxxxx",
  "url": "https://storage.url/path/to/image.jpg"
}
```

### 2.4 核桃采集接口

**接口路径**: `/collection`
**请求方式**: `POST`
**是否需要认证**: 是

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| `images` | `array` | `是` | 6个角度图片的fileId数组，对应['top', 'bottom', 'left', 'right', 'front', 'back'] |
| `size` | `number` | `是` | 核桃尺寸(mm)，范围33-42 |
| `angles` | `array` | `是` | 角度类型数组，包含['top', 'bottom', 'left', 'right', 'front', 'back'] |

**成功响应格式**:
```json
{
  "success": true,
  "collection_id": "ht_1234567890",
  "message": "采集成功"
}
```

### 2.5 核桃相似度对比接口

**接口路径**: `/compare`
**请求方式**: `POST`
**是否需要认证**: 是

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
| :--- | :--- | :--- | :--- |
| `images` | `array` | `是` | 6个角度图片的fileId数组，对应['top', 'bottom', 'left', 'right', 'front', 'back'] |
| `size` | `number` | `是` | 核桃尺寸(mm)，范围33-42 |
| `angles` | `array` | `是` | 角度类型数组，包含['top', 'bottom', 'left', 'right', 'front', 'back'] |

**成功响应格式**:
```json
{
  "success": true,
  "similarity": 89.5,
  "target_id": "ht_9876543210",
  "message": "对比完成",
  "texture_similarity": 90.1,
  "edge_similarity": 88.7,
  "color_similarity": 89.2,
  "top_results": [
    {
      "id": "ht_9876543210",
      "similarity": 89.5,
      "texture_similarity": 90.1,
      "edge_similarity": 88.7,
      "color_similarity": 89.2,
      "size": 38
    },
    {
      "id": "ht_9876543211",
      "similarity": 82.3,
      "texture_similarity": 81.5,
      "edge_similarity": 83.1,
      "color_similarity": 82.7,
      "size": 37
    },
    {
      "id": "ht_9876543212",
      "similarity": 79.8,
      "texture_similarity": 80.2,
      "edge_similarity": 78.9,
      "color_similarity": 79.4,
      "size": 39
    }
  ]
}
```

## 3. 前端数据存储

### 3.1 本地存储项
- `token`: 用户认证令牌
- `userInfo`: 用户信息对象（包含nickName、avatarUrl等）
- `lastSize`: 上次选择的核桃尺寸

### 3.2 全局数据管理
```javascript
// app.js中的全局数据
app.globalData = {
  isLoggedIn: false,
  token: '',
  windowHeight: 0,
  windowWidth: 0
}
```

## 4. 功能流程说明

### 4.1 登录流程
1. 用户点击登录/授权按钮
2. 小程序调用 `wx.login()` 获取code
3. 发送code到后端 `/api/login` 接口
4. 后端返回token和用户信息
5. 本地存储token和用户信息
6. 更新全局登录状态 `app.globalData.isLoggedIn = true`

### 4.2 核桃采集流程
1. 用户选择6个角度的核桃图片
2. 依次调用 `/api/upload` 接口获取每个图片的fileIds
3. 用户选择核桃尺寸
4. 提交采集数据到 `/api/collection` 接口
5. 获取collection_id，跳转到结果页面展示采集成功信息

### 4.3 相似度对比流程
1. 用户选择6个角度的核桃图片
2. 依次调用 `/api/upload` 接口获取每个图片的fileIds
3. 用户选择核桃尺寸
4. 提交对比数据到 `/api/compare` 接口
5. 获取相似度结果数据，跳转到结果页面展示对比结果

## 5. 错误处理机制

### 5.1 常见错误处理
- **登录失败**：显示Toast提示，要求重试
- **图片上传失败**：显示Toast提示，允许用户重新选择图片
- **网络异常**：显示"网络异常，请重试"提示
- **数据校验失败**：显示具体错误信息，引导用户修正
- **Token过期**：清除本地token，跳转到登录页面

### 5.2 接口调用封装
建议在小程序中封装统一的请求方法，处理通用逻辑：

```javascript
// request.js 示例
export const request = (url, method, data = {}, needAuth = true) => {
  return new Promise((resolve, reject) => {
    const header = {
      'Content-Type': 'application/json'
    };
    
    // 如果需要认证，添加token
    if (needAuth) {
      const token = wx.getStorageSync('token');
      if (!token) {
        wx.showModal({
          title: '登录过期',
          content: '请重新登录',
          success: (res) => {
            if (res.confirm) {
              wx.navigateTo({ url: '/pages/login/login' });
            }
          }
        });
        reject(new Error('未登录'));
        return;
      }
      header['Authorization'] = `Bearer ${token}`;
    }
    
    wx.request({
      url,
      method,
      data,
      header,
      success: (res) => {
        if (res.data.success) {
          resolve(res.data);
        } else {
          // 处理Token过期情况
          if (res.data.code === 401) {
            wx.removeStorageSync('token');
            wx.showModal({
              title: '登录过期',
              content: '请重新登录',
              success: (res) => {
                if (res.confirm) {
                  wx.navigateTo({ url: '/pages/login/login' });
                }
              }
            });
          }
          wx.showToast({
            title: res.data.message || '请求失败',
            icon: 'none'
          });
          reject(new Error(res.data.message || '请求失败'));
        }
      },
      fail: (error) => {
        wx.showToast({
          title: '网络异常，请重试',
          icon: 'none'
        });
        reject(error);
      }
    });
  });
};
```

## 6. 开发注意事项

1. **认证检查**：所有需要认证的接口调用前必须检查 `app.globalData.isLoggedIn`
2. **图片处理**：使用 `wx.chooseMedia()` 获取图片，支持相册和相机
3. **数据格式**：确保提交数据的格式与后端要求一致
4. **Token管理**：处理Token过期的情况，需要重新登录
5. **文件ID管理**：正确存储和管理上传图片返回的fileIds
6. **加载状态**：使用 `wx.showLoading()` 和 `wx.hideLoading()` 提供良好的用户体验
7. **错误反馈**：使用 `wx.showToast()` 提供清晰的错误提示
8. **参数验证**：前端进行必要的参数验证，如图片数量、尺寸范围等
9. **数据安全**：不在前端存储敏感信息，敏感操作需要服务端验证
10. **用户体验**：提供友好的加载动画和错误提示，避免用户操作无响应